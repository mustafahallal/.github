name: Org Heatmap Generator
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Emacs
        uses: purcell/setup-emacs@master
        with:
          version: '29.4' # GÜNCELLEME: ghub paketi için sürümü 29.4'e yükselttik

      - name: Install Emacs Dependencies
        # Emacsql, ghub ve dash paketlerini kuruyoruz
        run: |
          emacs --batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(package-refresh-contents)" \
            --eval "(package-install 'emacsql)" \
            --eval "(package-install 'ghub)" \
            --eval "(package-install 'dash)"

      - name: Generate Heatmap
        env:
          GITHUB_TOKEN: ${{ secrets.METRICS_TOKEN }}
        run: |
          # org-heatmap.el dosyasını çalıştır
          emacs --batch \
            --eval "(require 'package)" \
            --eval "(package-initialize)" \
            --load org-heatmap.el \
            --eval "(org-heatmap-generate \"mustafahallal\" \"heatmap.org\")"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "action@github.com"
          git add heatmap.org
          # Commit hatası almamak için || echo ekledik
          git commit -m "Update contribution heatmap" || echo "No changes to commit"
          git push
