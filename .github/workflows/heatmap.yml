name: Org Heatmap Generator
on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Emacs
        uses: purcell/setup-emacs@master
        with:
          version: '28.2'

      - name: Install Emacs Dependencies
        # Emacs paket yöneticisini (MELPA) kurup gerekli kütüphaneleri yüklüyoruz
        run: |
          emacs --batch \
            --eval "(require 'package)" \
            --eval "(add-to-list 'package-archives '(\"melpa\" . \"https://melpa.org/packages/\") t)" \
            --eval "(package-initialize)" \
            --eval "(package-refresh-contents)" \
            --eval "(package-install 'emacsql-sqlite)" \
            --eval "(package-install 'ghub)"

      - name: Generate Heatmap
        env:
          GITHUB_TOKEN: ${{ secrets.METRICS_TOKEN }}
        run: |
          # Önce bağımlılıkları yükle, sonra scripti çalıştır
          emacs --batch \
            --eval "(require 'package)" \
            --eval "(package-initialize)" \
            --load org-heatmap.el \
            --eval "(org-heatmap-generate \"mustafahallal\" \"heatmap.org\")"

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "action@github.com"
          git add heatmap.org
          # Değişiklik varsa commit yap, yoksa hata verme
          git commit -m "Update contribution heatmap" || echo "No changes to commit"
          git push
